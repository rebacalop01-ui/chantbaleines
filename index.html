<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Phrase Baleine</title>

<style>
body{
  background: linear-gradient(#023047,#219ebc);
  color:white;
  font-family: Arial, sans-serif;
  text-align:center;
  padding:24px;
}

h1{margin-bottom:10px}

button{
  padding:10px 16px;
  margin:6px;
  border-radius:10px;
  border:0;
  cursor:pointer;
  font-size:15px;
}

#sequenceDisplay{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
  margin-top:12px;
}

.bubble{
  background:rgba(255,255,255,0.15);
  padding:8px 14px;
  border-radius:18px;
}

.status{
  margin-top:12px;
  font-size:14px;
  opacity:0.95;
}
</style>
</head>

<body>

<h1>üêã Phrase Baleine</h1>

<div>
  <button onclick="addSound('Baleine1')">Baleine 1</button>
  <button onclick="addSound('Baleine2')">Baleine 2</button>
  <button onclick="addSound('Baleine3')">Baleine 3</button>
  <button onclick="addSound('Baleine4')">Baleine 4</button>
  <button onclick="addSound('Baleine5')">Baleine 5</button>
</div>

<div>
  <button onclick="playSequence()">‚ñ∂ Rejouer</button>
  <button onclick="stopAll()">‚èπ Stop</button>
  <button onclick="clearSequence()">üóë Effacer</button>
  <button onclick="exportSequenceAudio()">üéß T√©l√©charger audio</button>
</div>

<div id="status" class="status">Statut : pr√™t</div>

<h3>S√©quence :</h3>
<div id="sequenceDisplay">(aucune s√©lection)</div>

<!-- AUDIOS (GitHub Pages) -->
<audio id="Baleine1" src="sounds/baleine1.mp3"></audio>
<audio id="Baleine2" src="sounds/baleine2.mp3"></audio>
<audio id="Baleine3" src="sounds/baleine3.mp3"></audio>
<audio id="Baleine4" src="sounds/baleine4.mp3"></audio>
<audio id="Baleine5" src="sounds/baleine5.mp3"></audio>

<script>
/* ===== √âTAT ===== */
let sequence = [];
let activeAudios = [];

const seqEl = document.getElementById("sequenceDisplay");
const statusEl = document.getElementById("status");

function setStatus(text){
  statusEl.textContent = "Statut : " + text;
}

/* ===== AFFICHAGE ===== */
function renderSequence(){
  seqEl.innerHTML = "";
  if(sequence.length === 0){
    seqEl.textContent = "(aucune s√©lection)";
    return;
  }
  sequence.forEach((id, i)=>{
    const d = document.createElement("div");
    d.className = "bubble";
    d.textContent = (i+1) + ". " + id;
    seqEl.appendChild(d);
  });
}

/* ===== LECTURE ===== */
function playImmediate(id){
  const tag = document.getElementById(id);
  if(!tag) return;

  const audio = new Audio(tag.src);
  audio.play();
  activeAudios.push(audio);

  audio.onended = () => {
    activeAudios = activeAudios.filter(a => a !== audio);
  };
}

function addSound(id){
  sequence.push(id);
  renderSequence();
  playImmediate(id);
}

function playSequence(){
  if(sequence.length === 0) return;
  let i = 0;
  setStatus("Lecture...");
  function next(){
    if(i >= sequence.length){
      setStatus("Lecture termin√©e");
      return;
    }
    playImmediate(sequence[i]);
    const last = activeAudios[activeAudios.length - 1];
    if(last){
      last.onended = () => { i++; next(); };
    } else {
      i++; next();
    }
  }
  next();
}

function stopAll(){
  activeAudios.forEach(a=>{
    a.pause();
    a.currentTime = 0;
  });
  activeAudios = [];
  setStatus("Arr√™t√©");
}

function clearSequence(){
  sequence = [];
  renderSequence();
  setStatus("S√©quence effac√©e");
}

/* ===== EXPORT AUDIO WAV ===== */
async function exportSequenceAudio(){
  if(sequence.length === 0){
    alert("La s√©quence est vide");
    return;
  }

  setStatus("Cr√©ation du fichier audio...");

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const buffers = [];

  for(const id of sequence){
    const tag = document.getElementById(id);
    if(!tag) continue;

    const response = await fetch(tag.src);
    const arrayBuffer = await response.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    buffers.push(audioBuffer);
  }

  let totalLength = 0;
  buffers.forEach(b => totalLength += b.length);

  const finalBuffer = audioCtx.createBuffer(
    1,
    totalLength,
    audioCtx.sampleRate
  );

  let offset = 0;
  buffers.forEach(buffer => {
    finalBuffer.getChannelData(0).set(buffer.getChannelData(0), offset);
    offset += buffer.length;
  });

  const wavBlob = bufferToWav(finalBuffer);
  const url = URL.createObjectURL(wavBlob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "sequence_baleines.wav";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  setStatus("Audio t√©l√©charg√©");
}

/* ===== BUFFER ‚Üí WAV ===== */
function bufferToWav(buffer){
  const samples = buffer.getChannelData(0);
  const sampleRate = buffer.sampleRate;
  const length = samples.length * 2;
  const wavBuffer = new ArrayBuffer(44 + length);
  const view = new DataView(wavBuffer);

  function writeString(o,s){
    for(let i=0;i<s.length;i++) view.setUint8(o+i,s.charCodeAt(i));
  }

  writeString(0,"RIFF");
  view.setUint32(4,36+length,true);
  writeString(8,"WAVE");
  writeString(12,"fmt ");
  view.setUint32(16,16,true);
  view.setUint16(20,1,true);
  view.setUint16(22,1,true);
  view.setUint32(24,sampleRate,true);
  view.setUint32(28,sampleRate*2,true);
  view.setUint16(32,2,true);
  view.setUint16(34,16,true);
  writeString(36,"data");
  view.setUint32(40,length,true);

  let offset = 44;
  for(let i=0;i<samples.length;i++,offset+=2){
    const s = Math.max(-1,Math.min(1,samples[i]));
    view.setInt16(offset, s<0 ? s*0x8000 : s*0x7fff, true);
  }

  return new Blob([view],{type:"audio/wav"});
}

renderSequence();
</script>

</body>
</html>
